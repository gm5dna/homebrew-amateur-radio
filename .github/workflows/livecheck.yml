name: Livecheck

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      create_issues:
        description: 'Create issues for outdated casks'
        required: false
        default: 'true'
        type: boolean

jobs:
  livecheck:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap this repository
        run: |
          brew tap gm5dna/amateur-radio "$(pwd)"

      - name: Run livecheck on all casks
        id: livecheck
        run: |
          echo "Running livecheck..."

          # Run livecheck and capture output
          LIVECHECK_OUTPUT=$(brew livecheck --tap gm5dna/amateur-radio --newer-only 2>&1) || true

          echo "Livecheck output:"
          echo "$LIVECHECK_OUTPUT"

          # Save output for next steps
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$LIVECHECK_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if there are any updates
          if [ -z "$LIVECHECK_OUTPUT" ] || echo "$LIVECHECK_OUTPUT" | grep -q "^$"; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Create issues for outdated casks
        if: steps.livecheck.outputs.has_updates == 'true' && (github.event_name == 'schedule' || github.event.inputs.create_issues == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.livecheck.outputs.output }}`;
            const lines = output.split('\n').filter(line => line.includes('==>'));

            for (const line of lines) {
              // Parse: "cask-name: current ==> new"
              const match = line.match(/^([^:]+):\s*([^\s]+)\s*==>\s*([^\s]+)/);
              if (!match) continue;

              const [, caskName, currentVersion, newVersion] = match;
              const issueTitle = `Update ${caskName} to ${newVersion}`;

              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'update'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes(caskName) && issue.title.includes(newVersion)
              );

              if (!issueExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: `A new version of **${caskName}** is available.\n\n- Current version: \`${currentVersion}\`\n- New version: \`${newVersion}\`\n\nDetected by automated livecheck.`,
                  labels: ['update']
                });
                console.log(`Created issue: ${issueTitle}`);
              } else {
                console.log(`Issue already exists for ${caskName} ${newVersion}`);
              }
            }

      - name: Summary
        run: |
          echo "## Livecheck Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.livecheck.outputs.has_updates }}" == "true" ]; then
            echo "### Updates Available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.livecheck.outputs.output }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "All casks are up to date." >> $GITHUB_STEP_SUMMARY
          fi
