name: Livecheck

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      create_issues:
        description: 'Create issues for outdated casks'
        required: false
        default: 'true'
        type: boolean

jobs:
  livecheck:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap this repository
        run: |
          mkdir -p "$(brew --repository)/Library/Taps/gm5dna"
          ln -sf "$(pwd)" "$(brew --repository)/Library/Taps/gm5dna/homebrew-amateur-radio"

      - name: Run livecheck on all casks
        id: livecheck
        run: |
          echo "Running livecheck..."

          # Run livecheck, keeping stdout (updates) separate from stderr (errors)
          LIVECHECK_OUTPUT=$(brew livecheck --tap gm5dna/amateur-radio --newer-only 2>/dev/null) || true

          echo "Livecheck output:"
          echo "$LIVECHECK_OUTPUT"

          # Save output for next steps
          {
            echo "output<<EOF"
            echo "$LIVECHECK_OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Check if any lines contain "==>" indicating an actual version update
          if echo "$LIVECHECK_OUTPUT" | grep -q "==>"; then
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issues for outdated casks
        if: steps.livecheck.outputs.has_updates == 'true' && (github.event_name == 'schedule' || github.event.inputs.create_issues == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.livecheck.outputs.output }}`;
            const lines = output.split('\n').filter(line => line.includes('==>'));

            for (const line of lines) {
              // Parse: "cask-name: current ==> new"
              const match = line.match(/^([^:]+):\s*([^\s]+)\s*==>\s*([^\s]+)/);
              if (!match) continue;

              const [, caskName, currentVersion, newVersion] = match;
              const issueTitle = `Update ${caskName} to ${newVersion}`;

              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'update'
              });

              const issueExists = existingIssues.data.some(issue =>
                issue.title.includes(caskName) && issue.title.includes(newVersion)
              );

              if (!issueExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: `A new version of **${caskName}** is available.\n\n- Current version: \`${currentVersion}\`\n- New version: \`${newVersion}\`\n\nDetected by automated livecheck.`,
                  labels: ['update']
                });
                console.log(`Created issue: ${issueTitle}`);
              } else {
                console.log(`Issue already exists for ${caskName} ${newVersion}`);
              }
            }

      - name: Summary
        run: |
          HAS_UPDATES="${{ steps.livecheck.outputs.has_updates }}"
          LIVECHECK_OUTPUT="${{ steps.livecheck.outputs.output }}"
          {
            echo "## Livecheck Results"
            echo ""
            if [ "$HAS_UPDATES" == "true" ]; then
              echo "### Updates Available"
              echo '```'
              echo "$LIVECHECK_OUTPUT"
              echo '```'
            else
              echo "All casks are up to date."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
